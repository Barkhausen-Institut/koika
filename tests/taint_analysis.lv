;;; Unit tests to ensure that impure functions are not optimized out

(extfun impure () (bits 5))

(module taint_analysis
  (register v 5'b0)

  (cpp-preamble "
class extfuns {
  bits<5> state{0u};
public:
  bits<5> impure(const unit& /*ignored*/) {
    state = state + bits<5>{1u};
    return state;
  }
};")

  (rule keep_impure_exprs
    (ignore (+ (impure) (impure)))
    (write.0 v (impure)))

  (rule keep_impure_branches
    (if true
        (write.1 v 5'b0)
      (write.1 v 5'b0)))

  (scheduler s (sequence keep_impure_exprs keep_impure_branches)))
